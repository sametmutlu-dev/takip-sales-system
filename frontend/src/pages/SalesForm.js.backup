import React, { useState, useEffect } from 'react';
import {
  Container,
  Card,
  CardContent,
  Typography,
  Box,
  TextField,
  Button,
  Grid,
  Alert,
  CircularProgress,
  MenuItem,
  Divider,
  Stepper,
  Step,
  StepLabel
} from '@mui/material';
import {
  Save as SaveIcon,
  ArrowBack as ArrowBackIcon,
  Person as PersonIcon,
  LocationOn as LocationIcon,
  ShoppingCart as ShoppingCartIcon,
  AttachMoney as MoneyIcon
} from '@mui/icons-material';
import { useNavigate, useParams } from 'react-router-dom';
import { salesAPI } from '../services/api';

const SalesForm = () => {
  const navigate = useNavigate();
  const { id } = useParams();
  const isEdit = Boolean(id);

  const [loading, setLoading] = useState(false);
  const [error, setError] = useState(null);
  const [success, setSuccess] = useState(false);
  const [activeStep, setActiveStep] = useState(0);

  const [formData, setFormData] = useState({
    seller: {
      name: '',
      phone: '',
      email: ''
    },
    buyer: {
      name: '',
      phone: '',
      email: ''
    },
    address: {
      street: '',
      city: '',
      district: '',
      postalCode: '',
      country: 'TÃ¼rkiye'
    },
    product: {
      name: 'Petek',
      description: '',
      category: '',
      quantity: 1,
      unit: 'adet'
    },
    price: {
      amount: 0,
      currency: 'TRY',
      taxRate: 0
    },
    saleDate: new Date().toISOString().split('T')[0],
    status: 'completed',
    deliveryType: 'kargo',
    notes: ''
  });

  const steps = [
    'SatÄ±cÄ± Bilgileri',
    'AlÄ±cÄ± Bilgileri',
    'Adres Bilgileri',
    'ÃœrÃ¼n Bilgileri',
    'Fiyat ve Teslimat',
    'Ã–zet'
  ];

  useEffect(() => {
    if (isEdit) {
      fetchSaleData();
    }
  }, [id, isEdit]);

  const fetchSaleData = async () => {
    try {
      setLoading(true);
      const response = await salesAPI.getById(id);
      setFormData(response.data);
    } catch (err) {
      console.error('SatÄ±ÅŸ verisi hatasÄ±:', err);
      setError(err.response?.data?.message || 'SatÄ±ÅŸ verisi yÃ¼klenirken hata oluÅŸtu');
    } finally {
      setLoading(false);
    }
  };

  const handleInputChange = (section, field, value) => {
    setFormData(prev => ({
      ...prev,
      [section]: {
        ...prev[section],
        [field]: value
      }
    }));
  };

  const handleDirectInputChange = (field, value) => {
    setFormData(prev => ({
      ...prev,
      [field]: value
    }));
  };

  const handleNext = () => {
    setActiveStep(prev => prev + 1);
  };

  const handleBack = () => {
    setActiveStep(prev => prev - 1);
  };

  const handleSubmit = async () => {
    console.log("ðŸš€ Form submit baÅŸladÄ±");
    console.log("ðŸ“ Form data:", formData);
    try {
      setLoading(true);
      setError(null);

      if (isEdit) {
        await salesAPI.update(id, formData);
        setSuccess('SatÄ±ÅŸ baÅŸarÄ±yla gÃ¼ncellendi!');
      } else {
        await salesAPI.create(formData);
        setSuccess('SatÄ±ÅŸ baÅŸarÄ±yla oluÅŸturuldu!');
      }

      setTimeout(() => {
        navigate('/sales');
      }, 2000);
    } catch (err) {
      console.error('Form gÃ¶nderme hatasÄ±:', err);
      setError(err.response?.data?.message || 'Form gÃ¶nderilirken hata oluÅŸtu');
    } finally {
      setLoading(false);
    }
  };

  const renderStepContent = (step) => {
    switch (step) {
      case 0: // SatÄ±cÄ± Bilgileri
        return (
          <Grid container spacing={3}>
            <Grid item xs={12}>
              <Typography variant="h6" gutterBottom>
                <PersonIcon sx={{ mr: 1, verticalAlign: 'middle' }} />
                SatÄ±cÄ± Bilgileri
              </Typography>
            </Grid>
            <Grid item xs={12}>
              <TextField
                fullWidth
                label="SatÄ±cÄ± *"
                select
                value={formData.seller.name}
                onChange={(e) => handleInputChange('seller', 'name', e.target.value)}
                required
              >
                <MenuItem value="Ã–zgÃ¼r Cevizci">Ã–zgÃ¼r Cevizci</MenuItem>
                <MenuItem value="Mustafa DemirtaÅŸ">Mustafa DemirtaÅŸ</MenuItem>
                <MenuItem value="diÄŸer">DiÄŸer</MenuItem>
              </TextField>
            </Grid>
            {formData.seller.name === 'diÄŸer' && (
              <Grid item xs={12}>
                <TextField
                  fullWidth
                  label="SatÄ±cÄ± AdÄ± *"
                  value={formData.seller.name}
                  onChange={(e) => handleInputChange('seller', 'name', e.target.value)}
                  required
                  placeholder="SatÄ±cÄ± adÄ±nÄ± yazÄ±n"
                />
              </Grid>
            )}
          </Grid>
        );

      case 1: // AlÄ±cÄ± Bilgileri
        return (
          <Grid container spacing={3}>
            <Grid item xs={12}>
              <Typography variant="h6" gutterBottom>
                <PersonIcon sx={{ mr: 1, verticalAlign: 'middle' }} />
                AlÄ±cÄ± Bilgileri
              </Typography>
            </Grid>
            <Grid item xs={12} sm={6}>
              <TextField
                fullWidth
                label="AlÄ±cÄ± AdÄ± *"
                value={formData.buyer.name}
                onChange={(e) => handleInputChange('buyer', 'name', e.target.value)}
                required
              />
            </Grid>
            <Grid item xs={12} sm={6}>
              <TextField
                fullWidth
                label="Telefon"
                value={formData.buyer.phone}
                onChange={(e) => handleInputChange('buyer', 'phone', e.target.value)}
              />
            </Grid>
            <Grid item xs={12}>
              <TextField
                fullWidth
                label="Email"
                type="email"
                value={formData.buyer.email}
                onChange={(e) => handleInputChange('buyer', 'email', e.target.value)}
              />
            </Grid>
          </Grid>
        );

      case 2: // Adres Bilgileri
        return (
          <Grid container spacing={3}>
            <Grid item xs={12}>
              <Typography variant="h6" gutterBottom>
                <LocationIcon sx={{ mr: 1, verticalAlign: 'middle' }} />
                Adres Bilgileri
              </Typography>
            </Grid>
            <Grid item xs={12}>
              <TextField
                fullWidth
                label="AÃ§Ä±k Adres *"
                value={formData.address.street}
                onChange={(e) => handleInputChange('address', 'street', e.target.value)}
                required
                multiline
                rows={3}
                placeholder="Mahalle, sokak, bina no, daire no vb. detaylÄ± adres bilgisi"
              />
            </Grid>
            <Grid item xs={12} sm={6}>
              <TextField
                fullWidth
                label="Åžehir *"
                value={formData.address.city}
                onChange={(e) => handleInputChange('address', 'city', e.target.value)}
                required
              />
            </Grid>
            <Grid item xs={12} sm={6}>
              <TextField
                fullWidth
                label="Ä°lÃ§e"
                value={formData.address.district}
                onChange={(e) => handleInputChange('address', 'district', e.target.value)}
              />
            </Grid>
            <Grid item xs={12} sm={6}>
              <TextField
                fullWidth
                label="Posta Kodu"
                value={formData.address.postalCode}
                onChange={(e) => handleInputChange('address', 'postalCode', e.target.value)}
              />
            </Grid>
            <Grid item xs={12} sm={6}>
              <TextField
                fullWidth
                label="Ãœlke"
                value={formData.address.country}
                onChange={(e) => handleInputChange('address', 'country', e.target.value)}
              />
            </Grid>
          </Grid>
        );

      case 3: // ÃœrÃ¼n Bilgileri
        return (
          <Grid container spacing={3}>
            <Grid item xs={12}>
              <Typography variant="h6" gutterBottom>
                <ShoppingCartIcon sx={{ mr: 1, verticalAlign: 'middle' }} />
                ÃœrÃ¼n Bilgileri
              </Typography>
            </Grid>
            <Grid item xs={12}>
              <TextField
                fullWidth
                label="ÃœrÃ¼n *"
                select
                value={formData.product.name}
                onChange={(e) => handleInputChange('product', 'name', e.target.value)}
                required
              >
                <MenuItem value="Petek">Petek</MenuItem>
              </TextField>
            </Grid>
            <Grid item xs={12}>
              <TextField
                fullWidth
                label="ÃœrÃ¼n AÃ§Ä±klamasÄ±"
                value={formData.product.description}
                onChange={(e) => handleInputChange('product', 'description', e.target.value)}
                multiline
                rows={3}
                placeholder="ÃœrÃ¼n hakkÄ±nda ek bilgiler"
              />
            </Grid>
            <Grid item xs={12}>
              <TextField
                fullWidth
                label="Miktar *"
                type="number"
                value={formData.product.quantity}
                onChange={(e) => handleInputChange('product', 'quantity', parseInt(e.target.value) || 1)}
                required
                inputProps={{ min: 1 }}
                helperText="Birim: adet"
              />
            </Grid>
          </Grid>
        );

      case 4: // Fiyat ve Teslimat
        return (
          <Grid container spacing={3}>
            <Grid item xs={12}>
              <Typography variant="h6" gutterBottom>
                <MoneyIcon sx={{ mr: 1, verticalAlign: 'middle' }} />
                Fiyat ve Teslimat Bilgileri
              </Typography>
            </Grid>
            <Grid item xs={12} sm={6}>
              <TextField
                fullWidth
                label="Fiyat *"
                type="number"
                value={formData.price.amount}
                onChange={(e) => handleInputChange('price', 'amount', parseFloat(e.target.value) || 0)}
                required
                inputProps={{ min: 0, step: 0.01 }}
                InputProps={{
                  endAdornment: <Typography sx={{ ml: 1 }}>â‚º</Typography>
                }}
              />
            </Grid>
            <Grid item xs={12} sm={6}>
              <TextField
                fullWidth
                label="Para Birimi"
                select
                value={formData.price.currency}
                onChange={(e) => handleInputChange('price', 'currency', e.target.value)}
              >
                <MenuItem value="TRY">TRY - TÃ¼rk LirasÄ±</MenuItem>
                <MenuItem value="USD">USD - Amerikan DolarÄ±</MenuItem>
                <MenuItem value="EUR">EUR - Euro</MenuItem>
              </TextField>
            </Grid>
            <Grid item xs={12} sm={6}>
              <TextField
                fullWidth
                label="SatÄ±ÅŸ Tarihi *"
                type="date"
                value={formData.saleDate}
                onChange={(e) => handleDirectInputChange('saleDate', e.target.value)}
                required
                InputLabelProps={{ shrink: true }}
              />
            </Grid>
            <Grid item xs={12} sm={6}>
              <TextField
                fullWidth
                label="Durum"
                select
                value={formData.status}
                onChange={(e) => handleDirectInputChange('status', e.target.value)}
              >
                <MenuItem value="completed">TamamlandÄ±</MenuItem>
                <MenuItem value="pending">Beklemede</MenuItem>
                <MenuItem value="shipped">Kargoda</MenuItem>
                <MenuItem value="cancelled">Ä°ptal</MenuItem>
                <MenuItem value="refunded">Ä°ade</MenuItem>
              </TextField>
            </Grid>
            <Grid item xs={12}>
              <TextField
                fullWidth
                label="GÃ¶nderi Tipi"
                select
                value={formData.deliveryType}
                onChange={(e) => handleDirectInputChange('deliveryType', e.target.value)}
              >
                <MenuItem value="kargo">Kargo</MenuItem>
                <MenuItem value="elden">Elden Teslim</MenuItem>
                <MenuItem value="bayi">Bayi</MenuItem>
              </TextField>
            </Grid>
            <Grid item xs={12}>
              <TextField
                fullWidth
                label="Notlar"
                value={formData.notes}
                onChange={(e) => handleDirectInputChange('notes', e.target.value)}
                multiline
                rows={3}
                placeholder="Ek notlar ve aÃ§Ä±klamalar"
              />
            </Grid>
          </Grid>
        );

      case 5: // Ã–zet
        return (
          <Grid container spacing={3}>
            <Grid item xs={12}>
              <Typography variant="h6" gutterBottom>
                SatÄ±ÅŸ Ã–zeti
              </Typography>
            </Grid>
            <Grid item xs={12} md={6}>
              <Card variant="outlined">
                <CardContent>
                  <Typography variant="h6" gutterBottom>SatÄ±cÄ±</Typography>
                  <Typography><strong>Ad:</strong> {formData.seller.name}</Typography>
                </CardContent>
              </Card>
            </Grid>
            <Grid item xs={12} md={6}>
              <Card variant="outlined">
                <CardContent>
                  <Typography variant="h6" gutterBottom>AlÄ±cÄ±</Typography>
                  <Typography><strong>Ad:</strong> {formData.buyer.name}</Typography>
                  <Typography><strong>Telefon:</strong> {formData.buyer.phone || 'BelirtilmemiÅŸ'}</Typography>
                  <Typography><strong>Email:</strong> {formData.buyer.email || 'BelirtilmemiÅŸ'}</Typography>
                </CardContent>
              </Card>
            </Grid>
            <Grid item xs={12}>
              <Card variant="outlined">
                <CardContent>
                  <Typography variant="h6" gutterBottom>Adres</Typography>
                  <Typography>{formData.address.street}</Typography>
                  <Typography>{formData.address.district && `${formData.address.district}, `}{formData.address.city}</Typography>
                  <Typography>{formData.address.postalCode && `${formData.address.postalCode} `}{formData.address.country}</Typography>
                </CardContent>
              </Card>
            </Grid>
            <Grid item xs={12} md={6}>
              <Card variant="outlined">
                <CardContent>
                  <Typography variant="h6" gutterBottom>ÃœrÃ¼n</Typography>
                  <Typography><strong>Ad:</strong> {formData.product.name}</Typography>
                  <Typography><strong>Miktar:</strong> {formData.product.quantity} adet</Typography>
                  {formData.product.description && (
                    <Typography><strong>AÃ§Ä±klama:</strong> {formData.product.description}</Typography>
                  )}
                </CardContent>
              </Card>
            </Grid>
            <Grid item xs={12} md={6}>
              <Card variant="outlined">
                <CardContent>
                  <Typography variant="h6" gutterBottom>Fiyat ve Teslimat</Typography>
                  <Typography><strong>Fiyat:</strong> {formData.price.amount} {formData.price.currency}</Typography>
                  <Typography><strong>Tarih:</strong> {new Date(formData.saleDate).toLocaleDateString('tr-TR')}</Typography>
                  <Typography><strong>Durum:</strong> {formData.status}</Typography>
                  <Typography><strong>GÃ¶nderi Tipi:</strong> {formData.deliveryType}</Typography>
                </CardContent>
              </Card>
            </Grid>
          </Grid>
        );

      default:
        return null;
    }
  };

  if (loading && isEdit) {
    return (
      <Container maxWidth="lg">
        <Box sx={{ display: 'flex', justifyContent: 'center', mt: 4 }}>
          <CircularProgress />
        </Box>
      </Container>
    );
  }

  return (
    <Container maxWidth="lg">
      <Box sx={{ display: 'flex', alignItems: 'center', mb: 3 }}>
        <Button
          startIcon={<ArrowBackIcon />}
          onClick={() => navigate('/sales')}
          sx={{ mr: 2 }}
        >
          Geri
        </Button>
        <Typography variant="h4" component="h1">
          {isEdit ? 'SatÄ±ÅŸ DÃ¼zenle' : 'Yeni SatÄ±ÅŸ'}
        </Typography>
      </Box>

      {error && (
        <Alert severity="error" sx={{ mb: 3 }}>
          {error}
        </Alert>
      )}

      {success && (
        <Alert severity="success" sx={{ mb: 3 }}>
          {success}
        </Alert>
      )}

      <Card>
        <CardContent>
          <Stepper activeStep={activeStep} sx={{ mb: 4 }}>
            {steps.map((label) => (
              <Step key={label}>
                <StepLabel>{label}</StepLabel>
              </Step>
            ))}
          </Stepper>

          <Box sx={{ mb: 4 }}>
            {renderStepContent(activeStep)}
          </Box>

          <Divider sx={{ mb: 3 }} />

          <Box sx={{ display: 'flex', justifyContent: 'space-between' }}>
            <Button
              disabled={activeStep === 0}
              onClick={handleBack}
            >
              Geri
            </Button>

            <Box>
              {activeStep === steps.length - 1 ? (
                <Button
                  variant="contained"
                  startIcon={<SaveIcon />}
                  onClick={handleSubmit}
                  disabled={loading}
                >
                  {loading ? <CircularProgress size={20} /> : (isEdit ? 'GÃ¼ncelle' : 'Kaydet')}
                </Button>
              ) : (
                <Button
                  variant="contained"
                  onClick={handleNext}
                >
                  Ä°leri
                </Button>
              )}
            </Box>
          </Box>
        </CardContent>
      </Card>
    </Container>
  );
};

export default SalesForm;
